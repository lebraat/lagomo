name: Test Notifications

on:
  workflow_run:
    workflows: ["Test Suite"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Get workflow details
        uses: actions/github-script@v6
        id: workflow-details
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            let failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            let failureDetails = failedJobs.map(job => {
              return `${job.name}: ${job.steps.filter(step => step.conclusion === 'failure').map(step => step.name).join(', ')}`;
            }).join('\n');
            
            return {
              branch: run.data.head_branch,
              commit_message: run.data.head_commit.message,
              author: run.data.head_commit.author.name,
              author_email: run.data.head_commit.author.email,
              failed_jobs: failureDetails,
              run_url: context.payload.workflow_run.html_url
            };

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install @aws-sdk/client-ses

      - name: Send critical notification
        if: fromJson(steps.workflow-details.outputs.result).branch == 'main'
        run: |
          BODY="‚ö†Ô∏è CRITICAL: Tests Failed on Main Branch

          A test failure has occurred on the main branch.

          ## Failure Details
          - Branch: ${{ fromJson(steps.workflow-details.outputs.result).branch }}
          - Commit Message: ${{ fromJson(steps.workflow-details.outputs.result).commit_message }}
          - Author: ${{ fromJson(steps.workflow-details.outputs.result).author }}
          - Failed Jobs:
          ${{ fromJson(steps.workflow-details.outputs.result).failed_jobs }}

          ## Action Required
          Please investigate and fix the failing tests as soon as possible.

          View Workflow Run: ${{ fromJson(steps.workflow-details.outputs.result).run_url }}"

          node scripts/send-notification.js \
            "[CRITICAL] Tests Failed on Main Branch - Lagomo" \
            "$BODY" \
            "${{ secrets.NOTIFICATION_EMAIL }}"

      - name: Send PR notification
        if: fromJson(steps.workflow-details.outputs.result).branch != 'main'
        run: |
          BODY="# ‚ùå Tests Failed on PR Branch

          ## Details
          - Branch: ${{ fromJson(steps.workflow-details.outputs.result).branch }}
          - Commit: ${{ fromJson(steps.workflow-details.outputs.result).commit_message }}
          - Author: ${{ fromJson(steps.workflow-details.outputs.result).author }}

          ## Failed Jobs
          ${{ fromJson(steps.workflow-details.outputs.result).failed_jobs }}

          View Workflow Run: ${{ fromJson(steps.workflow-details.outputs.result).run_url }}"

          node scripts/send-notification.js \
            "[CI] Tests Failed on PR Branch - Lagomo" \
            "$BODY" \
            "${{ fromJson(steps.workflow-details.outputs.result).author_email }}"

      - name: Send coverage notification
        if: contains(fromJson(steps.workflow-details.outputs.result).failed_jobs, 'Test Coverage:')
        run: |
          BODY="‚ö†Ô∏è Test Coverage Alert

          The test coverage has fallen below the required threshold.

          ## Details
          - Branch: ${{ fromJson(steps.workflow-details.outputs.result).branch }}
          - Commit Message: ${{ fromJson(steps.workflow-details.outputs.result).commit_message }}
          - Author: ${{ fromJson(steps.workflow-details.outputs.result).author }}

          ## Action Required
          Please add more tests to improve coverage.

          View Workflow Run: ${{ fromJson(steps.workflow-details.outputs.result).run_url }}"

          node scripts/send-notification.js \
            "[WARNING] Test Coverage Below Threshold - Lagomo" \
            "$BODY" \
            "${{ secrets.NOTIFICATION_EMAIL }}"

      - name: Send nightly build notification
        if: github.event.workflow_run.head_branch == 'main' && contains(github.event.workflow_run.display_title, 'nightly')
        run: |
          BODY="# üåô Nightly Build Tests Failed

          ## Details
          - Branch: ${{ fromJson(steps.workflow-details.outputs.result).branch }}

          ## Failed Jobs
          ${{ fromJson(steps.workflow-details.outputs.result).failed_jobs }}

          View Workflow Run: ${{ fromJson(steps.workflow-details.outputs.result).run_url }}"

          node scripts/send-notification.js \
            "[NIGHTLY] Build Tests Failed - Lagomo" \
            "$BODY" \
            "${{ secrets.NOTIFICATION_EMAIL }}"
